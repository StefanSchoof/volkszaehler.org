version: '3'
services:

  database:
    image: mariadb
    environment:
      MYSQL_DATABASE: volkszaehler
      MYSQL_USER: vz
      MYSQL_PASSWORD: demo
      MYSQL_ROOT_PASSWORD: admin_demo
    networks:
    - volkszaehler

  volkszaehler:
    image: volkszaehler/volkszaehler
    ports:
    - 8080:8080
    environment:
    - VZ_PPM_WORKER_COUNT=2
    - VZ_DOCTRINE_CREATE_OR_UPDATE=true
    # NOTE: The init command will only work once the database is fully up and running.
    #       By putting restart: always docker-compose will retry starting this container
    #       and finally complete the database setup sequence.
    command: sh -c "
      sed -i s/localhost/database/ /vz/etc/config.yaml &&
      sed -i s/vz_admin/root/ /vz/etc/config.yaml &&
      sleep 1 &&
      volkszaehler"
    links:
    - database
    depends_on:
    - database
    networks:
    - volkszaehler
    restart: always

  push-server:
    image: volkszaehler/volkszaehler
    ports:
    - 5582:5582
    - 8082:8082
    command: sh -c "
      sed -i s/localhost/database/ /vz/etc/config.yaml &&
      /vz/bin/push-server"
    links:
    - database
    depends_on:
    - database
    networks:
    - volkszaehler
    restart: always

networks:
  volkszaehler:
